---
title: "StableLineCellCycle"
author: "Jason T. Serviss"
date: "05/01/2017"
output:
  html_document:
    theme: flatly
    toc: no
    code_folding: hide
---

#Introduction
miR34a is known to regulate cell cycle and, specifically, induce G1-phase arrest. Due to the increase observed in miR34a expression levels in cell lines over-expressing miR34a asRNA, we investigated if the cell cycle was perturbed in these cells.

#Methods
All cell lines were cultured at 5% CO2 and 37° C with Skov3 and PC3 cells in RPMI (Hyclone) and 2 mM L-glutamine. All growth mediums were supplemented with 10% heat-inactivated FBS and 50 μg/ml of streptomycin and 50 μg/ml of penicillin. 1x10^5 cells per well in a 6-well plate and harvested after 24hrs. Cells were washed in PBS and fixed in 4% PFA at room temperature overnight. PFA was removed, and cells were resuspended in 95% EtOH. The samples were then rehydrated in distilled water, stained with DAPI and analyzed by flow cytometry on a LSRII (BD Biosciences) machine. Resulting data was further processed using Flowjo software.

#Results

```{r, warning=FALSE, message=FALSE}
library(reshape2)
library(ggplot2)
library(ggthemes)
library(plyr)
library(scales)
library(extrafont)

data <- read.table('~/GitHub/miR34aFigures/inst/StableLineCellCycle/cellCycleData.txt', header=TRUE, sep="\t")
data$value <- data$value/100
data$log2Value <- log2(data$value)

#qqplot shows that the data is reasonably normal. The shapiro test is also used below. Note that a p < 0.05 indicates non-normality.
#qqnorm(data$log2Value)

#calculate statistics
stats <- ddply(
    data,
    c("cellLine", "condition", "phase"),
    summarize,
    mean=2^mean(log2Value),
    shapiroTest = shapiro.test(log2Value)$p.value,
    pValue=t.test(value, data[data$cellLine == unique(cellLine) & data$condition == "mock" & data$phase == unique(phase), "value"])$p.value,
    CI95l=2^t.test(log2Value)$conf.int[1],
    CI95h=2^t.test(log2Value)$conf.int[2]

)

data <- merge(data, stats, by=c("cellLine", "condition", "phase"), all.x=TRUE)

data$pStars <- ifelse(
    data$pValue < 0.05 & data$pValue > 0.0049, 
    "\u2605", 
    ifelse(
        data$pValue < 0.005 & data$pValue > 0.00049, 
        "\u2605\u2605",
        ifelse(
            data$pValue < 0.0005, 
            "\u2605\u2605\u2605",
            ""
        )
    )
)

#prepare for plotting
data$condition <- factor(data$condition, levels=c("mock", "miR34a AS"))
data$phase <- factor(data$phase, levels=c("G1", "S", "G2"))

Ys <- ddply(data, c("phase", "cellLine"), summarize, Ys=max(CI95h))

pBars <- data.frame(
    cellLine = c(rep("PC3", 3), rep("Skov3", 3)),
    phase = rep(c("G1", "S", "G2"), 2),
    condition = rep("miR34a AS", 6),
    x = rep(c(1,NA,3), 2)-0.25,
    xend = rep(c(1,NA,3), 2)+0.25,
    xStars = rep(c(1,2,3), 2)
)

pBars <- merge(pBars, Ys, by=c("cellLine", "phase"), all.x=TRUE)
data <-  merge(data, pBars, by=c("cellLine", "phase", "condition"), all.x=TRUE)

```

```{r, fig.align='center', fig.height=8, fig.width=12, eval=TRUE, message=FALSE, warning=FALSE}
#plot for rmarkdown
ggplot(data=data, aes(x=phase, y=value))+
    geom_violin(
        aes(fill=condition),
        scale="width", 
        alpha=0.3, 
        weight=10,
        trim=TRUE,
        color=NA,
        show.legend = FALSE
    )+
    geom_point(
        aes(group=interaction(phase, condition), color=condition),
        position=position_dodge(width=0.9),
        size=2
    )+
    geom_linerange(
        aes(ymin=CI95l, ymax=CI95h, group=interaction(phase, condition)),
        position=position_dodge(width=0.9),
        colour="grey25",
        show.legend = FALSE
    )+
    facet_grid(
        .~cellLine, 
        scale="free"
    )+
    geom_point(
        aes(x=phase, y=mean, group=condition), 
        colour="black",
        position=position_dodge(width=0.9),
        show.legend = FALSE
    )+
    scale_y_continuous(labels = percent_format())+
    geom_segment(
        aes(x=x, y=Ys+0.01, xend=xend, yend=Ys+0.01),
        colour="grey43",
        show.legend = FALSE
    )+
    geom_label(
        aes(y=Ys+0.02, label=pStars),
        label.size=0,
        label.padding=unit(0.01, "lines"),
        show.legend = FALSE,
        fill="white",
        size=3,
        family="Arial Unicode MS"
    )+
    labs(
      x="Cell cycle phase",
      title="Cell cycle",
      caption=
            "Cell cycle analysis in miR34a asRNA over-expressing PC3, Skov3, and Saos2 stable cell lines compared to their respective mock control.\nError bars (black vertical) indicate 95% CI and horizontal lines (black) represent the mean.\n\u2605 = p < 0.05; \u2605\u2605 = p < 0.005, \u2605\u2605\u2605 = p < 0.0005."
    )+
    theme_few()+
    scale_fill_ptol()+
    scale_colour_ptol()+
    theme(
        plot.title = element_text(
            hjust = 0.5,
            face="bold",
            size=22
        ),
        plot.caption = element_text(
            hjust=0, 
            margin=margin(t=15),
            family="Arial Unicode MS"
        ),
        legend.position="top",
        axis.title=element_text(size=17),
        axis.title.x=element_text(margin=margin(t=10)),
        axis.text=element_text(size=15),
        strip.text.x = element_text(size = 15),
        axis.title.y=element_blank(),
        legend.title=element_text(size=17),
        legend.text=element_text(size=15)
    )+ 
    guides(color=guide_legend(title="Condition"))

#plot for pdf
p <- ggplot(data=data, aes(x=phase, y=value))+
    geom_violin(
        aes(fill=condition),
        scale="width", 
        alpha=0.3, 
        trim=TRUE,
        color=NA,
        lwd = 0.1
    )+
    #geom_point(
    #    aes(group=interaction(phase, condition), color=condition),
    #    position=position_dodge(width=0.9),
    #    size=0.1
    #)+
    geom_linerange(
        aes(ymin=CI95l, ymax=CI95h, group=interaction(phase, condition)),
        position=position_dodge(width=0.9),
        colour="black",
        show.legend = FALSE,
        lwd=0.15
    )+
    facet_grid(
        .~cellLine, 
        scale="free"
    )+
    geom_point(
        aes(x=phase, y=mean, group=condition), 
        colour="black",
        position=position_dodge(width=0.9),
        size=0.1,
        show.legend = FALSE
    )+
    scale_y_continuous(labels = percent_format())+
    geom_segment(
        aes(x=x, y=Ys+0.01, xend=xend, yend=Ys+0.01),
        colour="grey43",
        show.legend = FALSE,
        lwd=0.2
    )+
    geom_label(
        aes(y=Ys+0.02, label=pStars),
        label.size=0,
        label.padding=unit(0.01, "lines"),
        show.legend = FALSE,
        fill="white",
        size=1,
        family="Arial Unicode MS"
    )+
    labs(
      x="Cell cycle phase"
      #title="Cell cycle"
    )+
    theme_few()+
    scale_fill_ptol()+
    scale_colour_ptol()+
    theme(
        plot.title = element_text(
            hjust = 0.5,
            face="bold",
            size=10,
            margin=margin(b=2, unit="mm")
        ),
        plot.margin = unit(rep(0.1, 4), "lines"),
        legend.margin=unit(1,"mm"),
        legend.position="top",
        legend.key.size = unit(1/5, "cm"),
        legend.title=element_text(size=9),
        legend.text=element_text(size=8),
        axis.title=element_text(size=9),
        axis.title.x=element_text(margin=margin(t=5)),
        axis.title.y=element_blank(),
        axis.ticks = element_line(size=0.25),
        axis.ticks.length = unit(1/15, "cm"),
        axis.text=element_text(size=8),
        #axis.line=element_line(size=0.15),
        panel.border = element_rect(fill=NA, size=0.15),
        panel.margin=unit(2, "mm"),
        strip.text.x = element_text(size = 8, margin = margin(0.01, 0, 0.1, 0, "cm"))
    )+ 
    guides(
        fill=guide_legend(
            title="Cell line", 
            override.aes = list(
                size=2
            )
        )
    )


ggsave(plot=p, filename="~/GitHub/miR34aFigures/inst/StableLineCellCycle/StableLineCellCycle.pdf", device=cairo_pdf, height=60, width=83, units="mm")
```

#Conclusion
An increase in the percentage of cells in G1-phase can be seen in cell lines overexpressing miR34a asRNA. In addition, a concominant decrease of cells in G2-phase can be observed.