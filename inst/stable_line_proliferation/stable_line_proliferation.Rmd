---
title: "???"
subtitle: "Monitoring proliferation of miR34a asRNA overexpressings cells under conditions of starvation"
author: "Jason T. Serviss"
date: "31/01/2017"
output:
  html_document:
    theme: flatly
    code_folding: hide
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

<style> 
.caption { 
  color: Black; 
  font-family: "Times New Roman", Times, serif;
  font-size: 1.0em; 
}
</style>

```{r, echo = FALSE, message = FALSE}

packages <- c(
    "tidyverse",
    "printr",
    "ggthemes",
    "miR34AasRNAproject",
    "broom"
)
purrr::walk(packages, library, character.only = TRUE)
rm(packages)

```

<br></br>

#### _Introduction_

As p53 is a well-known regulator of senescence, growth, and apoptosis and has been shown to specifically important under conditions of cellular stress, such as starvation. Therefore, we investigated whether overexpression of miR34a AS affects growth rate under normal and starvation conditions by measuring changes in confluency over time.

<br></br>

#### _Methods_

<br></br>

_Cell culture and proliferation assay_

20^4 PC3 cells, either miR34a asRNA overexpressing or mock, were harvested and stained in 1 ml PBS with 5uM CellTrace Violet (!!!!) for 5min and subsequently seeded in 12 well plates. Time 0 measurements were taken once cells had attatched and treatments with RPMI (Gibco, life technology) 10% FBS, RPMI 0.1% FBS, or HBSS were simultaniously initiated in the remaining cells. RPMI mediums were all additionally supplemented with 2mM L-glutamine and 50ug/ml Penicillin-Streptomycin and 10% Fetal Calf Serum. Cells were incubated for the indicated times before harvesting and CellTrace Violet was quantified via flow cytometry (Sony SH800S Cell Sorter). Time 0 was performed in biological triplicate and technical duplicate whereas all other time points were performed in biological triplicates with one technical replicate.

<br></br>

_Analysis_

Three technical triplicates were included in each experiment and these were independantly normalized for each condition to the 0 time point afterwhich the mean was calculated. The 95% confidence interval was then calculated based on the three independant experiments which were preformed.

<br></br>

#### _Results_

```{r, message = FALSE}

#data <- getData("Figure 3c")
dataUrl <- "https://github.com/GranderLab/miR34a_asRNA_project/raw/master"
path <- "data/stable_line_proliferation.rds"
data <- read_rds(gzcon(url(file.path(dataUrl, path))))

#remove cells with negative fluorescence. Consider these 1224 cells artifacts 
data <- filter(data, Violet > 0)

##fix day0 data
#Since there are no treatments at time 0 and we want a corresponding Time 0 for 
#each of the treated samples, here we expand the Time 0 sample 3 times, one for 
#each treatment condition at later time points.
dataExpandT0 <- data %>% 
  filter(Time == 0) %>%
  bind_rows(., ., .) %>%
  mutate(Condition = c(
      rep("Normal", nrow(.) / 3),
      rep("0.1% FBS", nrow(.) / 3),
      rep("HBSS", nrow(.) / 3)
  )) %>%
  bind_rows(filter(data, Time != 0))

#calculate means of technical replicates in day0
#need to subsample first so that each condition has the same number of cells
set.seed(2387723)
data0 <- dataExpandT0 %>%
  filter(Time == "0" & Type == "stained") %>%
  select(-`FSC-A`, -`BSC-A`) %>%
  group_by(`Biological replicate`, `Technical replicate`, Condition, `Cell line`, Type) %>%
  sample_n(size = 5000) %>%
  ungroup() %>%
  arrange(`Cell line`, Condition, `Biological replicate`, `Technical replicate`, Violet) %>%
  mutate(
    `Technical replicate` = rep(c("Tr1", "Tr2"), nrow(.)/2),
    row = rep(1:(nrow(.) / 2), each = 2)
  ) %>%
  spread(`Technical replicate`, Violet) %>%
  rowwise() %>%
  mutate(Violet = mean(c(Tr1, Tr2))) %>%
  ungroup() %>%
  select(-(row:Tr2)) %>%
  bind_rows(., ., ., .) %>%
  mutate(Time = rep(c("0", "24", "48", "72"), each = nrow(.) / 4)) %>%
  arrange(Time, `Cell line`, Condition, `Biological replicate`, Violet)

#Randomly sample 5000 cells from each condition so that all samples have the 
#same number of cells
set.seed(2387723)
subData <- dataExpandT0 %>%
  select(-`FSC-A`, -`BSC-A`, -`Technical replicate`) %>%
  filter(Type == "stained" & Time != "0") %>%
  group_by(`Biological replicate`, Condition, `Cell line`, Type, Time) %>%
  sample_n(size = 5000) %>%
  ungroup() 

#add back data from time point 0 with mean technical replicates calculated
#in addition, add a time point 0 corresponding to each cell and condition and
##calculate the difference for each cell from time 0
subData <- subData %>%
  bind_rows(filter(data0, Time == "0")) %>%
  arrange(Time, `Cell line`, Condition, `Biological replicate`, Violet) %>%
  add_column(day0Violet = data0$Violet) %>%
  mutate(violetNorm = Violet - day0Violet)


means <- subData %>%
  group_by(Time, `Cell line`, Condition) %>%
  summarize(
    mean = mean(violetNorm),
    CI95l = t.test(violetNorm)$conf.int[1],
    CI95h = t.test(violetNorm)$conf.int[2]
  )
  
subData %>%
  ggplot() +
  geom_smooth(aes(Time, violetNorm, colour = `Cell line`, group = `Cell line`), method = "lm") +
  geom_point(data = means, aes(Time, mean, colour = `Cell line`, group = `Cell line`)) +
  facet_wrap(~Condition) + 
  scale_y_continuous(breaks = c(0, -5000, -10000, -15000, -20000)) +
  theme_few()

#linear model
model.data <-  data %>%
  mutate(Time = as.numeric(Time)) %>%
  group_by(Treatment) %>%
  mutate(rank = rank(techMean)) %>%
  do(glance(lm(rank ~ Time +`Cell line`, data = .))) %>%
  ungroup() %>%
  rename(pValue = p.value) %>%
  pFormat(.) %>%
  select(-pValue) %>%
  rename(p.value = pFormat)

as.data.frame(model.data)

growth.lm <- data %>%
  mutate(Time = as.numeric(Time)) %>%
  group_by(Treatment) %>%
  mutate(rank = rank(techMean)) %>%
  do(tidy(lm(rank ~ Time +`Cell line`, data = .))) %>%
  ungroup() %>%
  rename(pValue = p.value) %>%
  pFormat(.) %>%
  select(-pValue) %>%
  rename(p.value = pFormat)

as.data.frame(growth.lm)

```

```{r, fig.align='center', fig.height=8, fig.width=12}

p <- ggplot(data = NULL) +
  geom_ribbon(
    data = stats,
    aes(
      x = Time,
      ymin = CI95l, 
      ymax = CI95h, 
      group = `Cell line`,
      fill = `Cell line`
    ), 
    alpha = 0.2,
    show.legend = FALSE
  ) +
  facet_grid(. ~ Treatment) +
  scale_x_discrete(breaks = seq(0, 35, 5)) +
  labs(
    x = "Time (hours)", 
    y = "Normalized % confluency",
    title = "miR34a asRNA's role in growth regulation."
  ) + 
  guides(
    colour = guide_legend(title = "Cell line", override.aes = list(size = 3))
  )

markdown <- p +
  geom_linerange(
    data = stats,
    aes(
      x = Time,
      colour = `Cell line`,
      ymin = min,
      ymax = max
    ), 
    position = position_dodge(width = 1),
    show.legend = FALSE
  ) + 
  geom_point(
    data = stats,
    aes(
      x = Time, 
      y = median,
      group = `Cell line`,
      colour = `Cell line`
    ), 
    position = position_dodge(width = 1),
    show.legend = TRUE
  ) + 
  guides(
    colour = guide_legend(
      title = "Cell line", 
      override.aes = list(size = 3)
    )
  )

plotRmarkdown(markdown)

pdf <- p +
  geom_linerange(
    data = stats,
    aes(
      x = Time,
      colour = `Cell line`,
      ymin = min,
      ymax = max
    ), 
    position = position_dodge(width = 1),
    lwd = 0.2,
    show.legend = FALSE
  ) + 
  geom_point(
    data = stats,
    aes(
      x = Time, 
      y = median,
      group = `Cell line`,
      colour = `Cell line`
    ), 
    size = 0.25,
    position = position_dodge(width = 1),
    show.legend = TRUE
  ) + 
  guides(
    colour = guide_legend(
      title = "Cell line", 
      override.aes = list(size = 2)
    )
  )

figure <- plotPDF(pdf)

# path <- file.path("~/GitHub/miR34a_asRNA_project/inst", fileMap(type = "pdf")["Figure 3c"][[1]])
# ggsave(
#   plot = figure,
#   filename = path,
#   device = cairo_pdf,
#   height = 60,
#   width = 83,
#   units = "mm"
# )
```

<div class="caption">
The effects of miR34a asRNA overexpression on growth in normal and starvation conditions in the PC3 prostate cancer cell line. The points represent the median values obtained from each independant experiment (n = 3) whereas, the shadow represents 95% confidence interval, and the vertical line represents the minimum and maximum values from the independant experiments.
</div>

<br></br>

#### _Conclusions_

miR34a asRNA overexpression causes a minor decrease in cell growth under normal conditions (RPMI) although under conditions of cellular stress through starvation, this effect is increased dramatically. 

<br></br><br></br>

```{r}
sessionInfo()
```
