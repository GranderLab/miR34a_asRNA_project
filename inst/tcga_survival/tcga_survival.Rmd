---
title: "Figure 4a-4b"
subtitle: "lncTAM34a survival analysis in TCGA cancers"
author: "Jimmy Van den Eynden and Jason T. Serviss"
date: "31/01/2017"
output:
  html_document:
    theme: flatly
    code_folding: hide
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style> 
.caption { 
  color: Black; 
  font-family: "Times New Roman", Times, serif;
  font-size: 1.0em; 
}
</style>

```{r, echo = FALSE, message = FALSE}

packages <- c(
    "tidyverse",
    "printr",
    "ggthemes",
    "readr",
    "miR34AasRNAproject",
    "grid",
    "gtable"
)
purrr::walk(packages, library, character.only = TRUE)
rm(packages)


#library(grDevices)
```

```{r}

projectUrl <- "https://github.com/GranderLab/miR34a_asRNA_project/raw/master/inst"
dataUrl <- "https://github.com/GranderLab/miR34a_asRNA_project/raw/master/"

```

**_Please note that the following script has not yet been fully integrated into the package and, therefore, is included here to facilitate transparency although re-running the script in real-time is not yet supported. This will be resolved before publication._**

Data were derived from TCGA:

* **data/lncRNA_cancer_id.rds**: Matrix containing for each TCGA barcode information regarding cancer type.
* **data/lncRNA_clin.rds**: Matrix containing for each TCGA barcode information regarding vital state (first column) and date of last follow-up (second column). Data were downloaded from TCGA on 20171027.
* **data/lncRNA_TCGA_TP53_hasNonsynMut.rds**: Named vector containing for each TCGA barcode information regarding TP53 nonSynonymous mutation state: FALSE if no mutation or synonymous mutations, TRUE if mutated. Mutect2 v7 called data were downloaded from TCGA on 20171030.
* **data/lncRNA_expr_RP3.rds**: Named numeric vector containing for each TCGA barcode information regarding RP3-510D11.2 expression. For details on RNA-Seq processing, see *Ashouri A et al. Nat Commun. 2016;7*
* **data/lncRNA_cna_RP3.rds**: Named numeric vector containing for each TCGA barcode information regarding RP3-510D11.2 copy number alteration (gene-based segmentation values). For details on processing, see *Ashouri A et al. Nat Commun. 2016;7*
* **data/lncRNA_expr_miR34a.rds**: Named numeric vector containing for each TCGA barcode information regarding miR34a expression. For details on RNA-Seq processing, see *Ashouri A et al. Nat Commun. 2016;7*
* **data/lncRNA_TCGA_BRCA_PAM50.rds**: Named character vector containing for each TCGA barcode from the breast cancer dataset information regarding PAM50 classification: LumA, LumB, Basal or Her2. For details on PAM50 classification, see *Ashouri A et al. Nat Commun. 2016;7*

```{r, eval = FALSE}
TCGA_cancer_id<- readRDS("data/lncRNA_cancer_id.rds") # TCGA Subtype IDs
TCGA_clin_surv<- readRDS("data/lncRNA_clin.rds") # Survival data
TCGA_TP53_hasNonsynMut<- readRDS("data/lncRNA_TCGA_TP53_hasNonsynMut.rds") # Survival data
RP3_expr<- readRDS(file = "data/lncRNA_expr_RP3.rds")
RP3_cna<- readRDS(file = "data/lncRNA_cna_RP3.rds")
miR34a_expr<- readRDS(file = "data/lncRNA_expr_miR34a.rds")
TCGA_PAM50<- readRDS(file = "data/lncRNA_TCGA_BRCA_PAM50.rds")
```

## Functions

```{r, eval = FALSE}
source("functions/create_survival_plot.R") # Function used to create survival plots
source("functions/create_expression_groups.R") # Function used to divide samples based on expression percentile thresholds
source("functions/get_survival.R") # Function used to calculate survival probabilities
```

## Libraries
```{r, eval = FALSE}
  library(survival)
  library(KMsurv)
  library(svglite)
  library(WriteXLS)
```

# Survival analysis per cancer type

## Kaplan-Meier

```{r, message=F, warning=F, eval = FALSE}

    # Get cancers for which all expression data available: 17 in total
    cancers<- sort(names(table(TCGA_cancer_id[names(RP3_expr),1])))
    
    # Set expression th
    th1<- 0.1
    th2<- 1-th1
    
    p_vals<- NULL      
    # Create plots
  for(plot_format in 1:2){
    if(plot_format==1) pdf("figs/lncRNA_survival_KM.pdf",width = 17,height = 24)
    else svglite("figs/lncRNA_survival_KM.svg",width = 17,height = 24)
    par(mfrow=c(9,6))
    for(cancer in cancers){
      samples_cancer<- rownames(TCGA_cancer_id)[TCGA_cancer_id[,1]==cancer]
      
      # Mutation only for TP53
      TCGA_TP53_hasNonsynMut_temp<- TCGA_TP53_hasNonsynMut[names(TCGA_TP53_hasNonsynMut)%in%samples_cancer]
      names(TCGA_TP53_hasNonsynMut_temp)<- substr(names(TCGA_TP53_hasNonsynMut_temp),1,12)
      clin_class<- cbind(TCGA_clin_surv,TCGA_TP53_hasNonsynMut_temp[rownames(TCGA_clin_surv)])
      n1<- sum(clin_class[,3]==FALSE,na.rm=T)
      n2<- sum(clin_class[,3]==TRUE,na.rm=T)
      if(nrow(clin_class)==0|sum(!is.na(clin_class[,3]))==0) plot.new() # No use if no motation information
      else p1<- create_survival_plot(clinical_data = clin_class,classes_to_compare = c(FALSE,TRUE),classnames=c(paste("TP53 WT (n=",n1,")",sep=""),paste("TP53 MUT (n=",n2,")",sep="")),plot_title =  cancer,save_plot = TRUE,add_to_existing_plot = TRUE, plot_cols = c("black","black"), plot_lty = 1:2,return_p = TRUE)
      
    # Expr + Mutation
    for(i in 1:2){
      expr<- list(RP3_expr,miR34a_expr)[[i]]
      gene<- c("miR34a asRNA","miR34a")[i]
      # for(isMut in c(F,T)){
      isMut=FALSE
        samples_cancer_sel<- intersect(names(TCGA_TP53_hasNonsynMut)[TCGA_TP53_hasNonsynMut==isMut],samples_cancer)
        expr_temp<- expr[names(expr)%in%samples_cancer_sel]
        class<- create_expression_groups(expr_temp,gene,th=c(th1,th2))
        names(class)<- substr(names(class),1,12)
        class[class==3]<- 2
        clin_class<- cbind(TCGA_clin_surv[names(class),],class)
        if(sum(!is.na(clin_class[,3]))==0) next
        n1<- sum(clin_class[,3]==1,na.rm=T)
        n2<- sum(clin_class[,3]==2,na.rm=T)
        n3<- sum(clin_class[,3]==3,na.rm=T)
        # if(nrow(clin_class)==0|sum(!is.na(clin_class[,3]))==0|n1==0|n2==0|n3==0) plot.new()
        if(nrow(clin_class)==0|sum(!is.na(clin_class[,3]))==0|n1==0|n2==0) plot.new()
        else px<- create_survival_plot(clinical_data = clin_class,classes_to_compare = c(1,2),classnames=c(paste("Low expression (<P",100*th1," - n=",n1,")",sep=""),paste( "Normal expression (>P",100*th1," - n=",n2,")",sep="")),plot_title = paste(cancer,gene,sep=" "),save_plot = TRUE,add_to_existing_plot = TRUE,plot_cols = c("black","red"), plot_lty=rep(1+isMut,2),return_p = TRUE)
      # }
        if(i==1) p2<- px
        if(i==2) p3<- px
    }
      p_vals<- cbind(p_vals,c(p1,p2,p3))
    }
    dev.off()
  }
    
  p_vals<- p_vals[,1:17]
  colnames(p_vals)<- cancers
  rownames(p_vals)<- c("TP53","miR34a_asRNA","miR34a")
```

## 5y survival probabilities

```{r, message=F, warning=F, eval = FALSE}

# Create correlation matrix
common_samples<- intersect(names(TCGA_TP53_hasNonsynMut),names(RP3_expr))
correlation_matrix<- cbind(RP3=RP3_expr[common_samples],miR34a=miR34a_expr[common_samples],TP53=TCGA_TP53_hasNonsynMut[common_samples],cancer=TCGA_cancer_id[common_samples,1])

n_years<- 5

# Get surv probs
cancers<- sort(unique(correlation_matrix[,"cancer"]))
survProb_ls<- list()

# Independent
for(gene in c("RP3","miR34a","TP53")){
  cat(gene,"\n")
  surv_matrix<- matrix(NA,3,length(cancers),dimnames = list(1:3,cancers))
  for(cancer in cancers){
    correlation_matrix_temp<- correlation_matrix[correlation_matrix[,"cancer"]==cancer,]
    if(gene!="TP53") correlation_matrix_temp<- cbind(correlation_matrix_temp,class=create_expression_groups(t(correlation_matrix_temp),gene,th=c(0.1,0.9)))
    else correlation_matrix_temp<- cbind(correlation_matrix_temp,class=as.numeric(correlation_matrix_temp[,gene]=="TRUE")+1) 
    for(i in 1:2){
      if(i==1) samples_sel<- rownames(correlation_matrix_temp)[correlation_matrix_temp[,"class"]==i]
      else samples_sel<- rownames(correlation_matrix_temp)[correlation_matrix_temp[,"class"]%in%c(2,3)]
      if(length(samples_sel)<=1) next
      surv_data<- TCGA_clin_surv[rownames(TCGA_clin_surv)%in%substr(samples_sel,1,12),]
      survProb<- get_survival(surv_data,n_years)
      if(length(survProb)==0) next
      surv_matrix[i,cancer]<- survProb
    }
  }
  survProb_ls[gene]<- list(surv_matrix)
}

# TP53 status dependent
for(gene in c("RP3","miR34a")){
  cat(gene,"\n")
  for(mut in c(0,1)){
    surv_matrix<- matrix(NA,3,length(cancers),dimnames = list(1:3,cancers))
    for(cancer in cancers){
      correlation_matrix_temp<- correlation_matrix[correlation_matrix[,"cancer"]==cancer&as.numeric(correlation_matrix[,"TP53"]=="TRUE")==mut,,drop=F]
      if(nrow(correlation_matrix_temp)<=1) next
      correlation_matrix_temp<- cbind(correlation_matrix_temp,class=create_expression_groups(t(correlation_matrix_temp),gene,th=c(0.1,0.9)))
      for(i in 1:2){
        if(i==1) samples_sel<- rownames(correlation_matrix_temp)[correlation_matrix_temp[,"class"]==i]
        else samples_sel<- rownames(correlation_matrix_temp)[correlation_matrix_temp[,"class"]%in%c(2,3)]
        if(length(samples_sel)<=1) next
        surv_data<- TCGA_clin_surv[rownames(TCGA_clin_surv)%in%substr(samples_sel,1,12),]
        survProb<- get_survival(surv_data,n_years)
        if(length(survProb)==0) next
        surv_matrix[i,cancer]<- survProb
      }
    }
    survProb_ls[paste(gene,mut,sep="_")]<- list(surv_matrix)
  }
}

# Remove NA!
survProb_ls[["RP3"]]<- survProb_ls[["RP3"]][,!is.na(survProb_ls[["RP3"]][1,])&!is.na(survProb_ls[["RP3"]][2,])]
survProb_ls[["miR34a"]]<- survProb_ls[["miR34a"]][,!is.na(survProb_ls[["miR34a"]][1,])&!is.na(survProb_ls[["miR34a"]][2,])]
survProb_ls[["TP53"]]<- survProb_ls[["TP53"]][,!is.na(survProb_ls[["TP53"]][1,])&!is.na(survProb_ls[["TP53"]][2,])]
survProb_ls[["RP3_0"]]<- survProb_ls[["RP3_0"]][,!is.na(survProb_ls[["RP3_0"]][1,])&!is.na(survProb_ls[["RP3_0"]][2,])]
survProb_ls[["RP3_1"]]<- survProb_ls[["RP3_1"]][,!is.na(survProb_ls[["RP3_1"]][1,])&!is.na(survProb_ls[["RP3_1"]][2,])]
survProb_ls[["miR34a_0"]]<- survProb_ls[["miR34a_0"]][,!is.na(survProb_ls[["miR34a_0"]][1,])&!is.na(survProb_ls[["miR34a_0"]][2,])]
survProb_ls[["miR34a_1"]]<- survProb_ls[["miR34a_1"]][,!is.na(survProb_ls[["miR34a_1"]][1,])&!is.na(survProb_ls[["miR34a_1"]][2,])]
# 
# for(plot_format in 1:2){
#   if(plot_format==1) pdf("figs/lncRNA_5ySurv_expr.pdf",width = 14, height = 14)
#   else svglite("figs/lncRNA_5ySurv_expr.svg",width = 14, height = 14)
# 
#   par(mfrow=c(2,1))
# 
#   boxplot(list(
#     survProb_ls[["RP3"]][1,],survProb_ls[["RP3"]][2,],NA,
#     survProb_ls[["miR34a"]][1,],survProb_ls[["miR34a"]][2,],NA,
#     survProb_ls[["TP53"]][2,],survProb_ls[["TP53"]][1,]),
#     outline=F,ylab=paste(n_years,"y survival probability",sep=""),frame.plot=F,axes=F,col=c("lightgrey",NA,NA,"lightgrey",NA,NA,"darkgrey",NA)
#   )
#   axis(2)
#   text(1.5,1,paste("P=",signif(wilcox.test(survProb_ls[["RP3"]][1,],survProb_ls[["RP3"]][2,],paired=T)$p.value,3),sep=""))
#   text(4.5,1,paste("P=",signif(wilcox.test(survProb_ls[["miR34a"]][1,],survProb_ls[["miR34a"]][2,],paired=T)$p.value,3),sep=""))
#   text(7.5,1,paste("P=",signif(wilcox.test(survProb_ls[["TP53"]][1,],survProb_ls[["TP53"]][2,],paired=T)$p.value,3),sep=""))
#   text(1.5,1.05,"miR34a asRNA",xpd=NA)
#   text(4.5,1.05,"miR34a",xpd=NA)
#   text(7.5,1.05,"TP53",xpd=NA)
#   legend("bottom",horiz = T,legend = c("Control","Low expression (<P10)","Mutated"),fill = c("white","lightgrey","darkgrey"),bty="n")
#   
#   boxplot(list(
#     survProb_ls[["RP3_0"]][1,],survProb_ls[["RP3_0"]][2,],NA,
#     survProb_ls[["RP3_1"]][1,],survProb_ls[["RP3_1"]][2,],NA,
#     survProb_ls[["miR34a_0"]][1,],survProb_ls[["miR34a_0"]][2,],NA,
#     survProb_ls[["miR34a_1"]][1,],survProb_ls[["miR34a_1"]][2,]),
#     outline=F,ylab=paste(n_years,"y survival probability",sep=""),frame.plot=F,axes=F,col=c("lightgrey",NA,NA,"lightgrey",NA,NA,"lightgrey",NA,NA,"lightgrey",NA)
#   )
#   axis(2)
#   text(1.5,1,signif(wilcox.test(survProb_ls[["RP3_0"]][1,],survProb_ls[["RP3_0"]][2,],paired=T)$p.value,3))
#   text(4.5,1,signif(wilcox.test(survProb_ls[["RP3_1"]][1,],survProb_ls[["RP3_1"]][2,],paired=T)$p.value,3))
#   text(7.5,1,signif(wilcox.test(survProb_ls[["miR34a_0"]][1,],survProb_ls[["miR34a_0"]][2,],paired=T)$p.value,3))
#   text(10.5,1,signif(wilcox.test(survProb_ls[["miR34a_1"]][1,],survProb_ls[["miR34a_1"]][2,],paired=T)$p.value,3))
#   text(3,1.1,"miR34a asRNA",xpd=NA)
#   text(1.5,1.05,"TP53 wt",xpd=NA)
#   text(4.5,1.05,"TP53 mut",xpd=NA)
#   text(9,1.1,"miR34a",xpd=NA)
#   text(7.5,1.05,"TP53 wt",xpd=NA)
#   text(10.5,1.05,"TP53 mut",xpd=NA)
#   legend("bottom",horiz = T,legend = c("Control","Low expression (<P10)"),fill = c("white","lightgrey"),bty="n")
#   
#   dev.off()
# }


# Correlation between survival
 cancer_colors<- c(
  rgb(0.498,0.498,0.498),
  rgb(0.7804,0.7804,0.7804),
  rgb(0.1216,0.4667,0.7059),
  rgb(0.1216,0.4667,0.7059),
  rgb(0.6824,0.7804,0.9098),
  rgb(0.0902,0.7451,0.8118),
  rgb(0.6196,0.8941,0.898),
  rgb(1,0.498,0.0549),
  rgb(1,0.7333,0.4706),
  rgb(0.8392,0.1529,0.1569),
  rgb(1,0.5961,0.5882),
  rgb(0.5804,0.4039,0.7412),
  rgb(0.7725,0.6118,0.7961),
  rgb(0.8902,0.4667,0.7608),
  rgb(0.9686,0.7137,0.8235),
  rgb(0.549,0.3373,0.2941),
  rgb(0.7686,0.6118,0.5804),
  rgb(0.1725,0.6275,0.1725),
  rgb(0.5961,0.8745,0.5412),
  rgb(0.7373,0.7412,0.1333),
  rgb(0.8588,0.8824,0.5529),
  rgb(0.9294,0.8,0.0588),
  rgb(1,0.9255,0)
)
  names(cancer_colors)<- c('ACC','BLCA','BRCA','BRCA Basal','BRCA Her2','BRCA LumA','BRCA LumB','CESC','GBM','HNSC','KICH','KIRC','KIRP','LGG','LIHC','LUAD','LUSC','OV','PRAD','SKCM','STAD','THCA','UCS')


for(plot_format in 1:2){
  if(plot_format==1) pdf("figs/lncRNA_5ySurv_expr_corr.pdf",width = 14, height = 7)
  else svglite("figs/lncRNA_5ySurv_expr_corr.svg",width = 21, height = 7)

  par(mfrow=c(1,3))
  
  # Focus on WT group only!
  survProb_rel_RP3<- survProb_ls[["RP3_0"]][1,]-survProb_ls[["RP3_0"]][2,]
  survProb_rel_miR34a<- survProb_ls[["miR34a_0"]][1,]-survProb_ls[["miR34a_0"]][2,]
  survProb_rel_TP53<- survProb_ls[["TP53"]][2,]-survProb_ls[["TP53"]][1,]
  
  for(i in 1:3){
    x_param_name<- c("TP53","miR34a_asRNA","miR34a")[i]
    x_param<- list(survProb_rel_TP53,survProb_rel_RP3,survProb_rel_miR34a)[[i]]
    y_param_name<- c("miR34a_asRNA","miR34a","TP53")[i]
    y_param<- list(survProb_rel_RP3,survProb_rel_miR34a,survProb_rel_TP53)[[i]]
    common_cancers<- intersect(names(x_param),names(y_param))
    x_param<- x_param[common_cancers]
    y_param<- y_param[common_cancers]
    plot(x_param,y_param,frame.plot=F,xlim=c(-1,+1),ylim=c(-1,+1),xlab=x_param_name,ylab=y_param_name)  
    boxplot(y_param,at = 0.75,add=T,frame.plot=F,outline=F,boxwex=0.2)
    boxplot(x_param,at = 0.75,add=T,frame.plot=F,outline=F,horizontal = T,boxwex=0.2)
    p_temp<- signif(cor.test(x_param,y_param,method = "spearman")$p.value,3)
    r_temp<- signif(cor.test(x_param,y_param,method = "spearman")$estimate,3)
    legend("topleft",legend = c(paste("P=",p_temp,sep=""),paste("r=",r_temp,sep="")),bty="n")
    for(cancer in common_cancers){
      points(x_param[cancer],y_param[cancer],col=cancer_colors[cancer],pch=16,cex=2)
    }
    # abline(h=0,v=0,lty=2)
  }
  dev.off()
}
 
  # Survival effects
  median(survProb_rel_RP3) # -0.096
  median(survProb_rel_miR34a) # -0.068
  median(survProb_rel_TP53) # -0.064
  wilcox.test(survProb_rel_RP3) # p=0.083
  wilcox.test(survProb_rel_miR34a) # p=0.17
  wilcox.test(survProb_rel_TP53) # p=0.04

```